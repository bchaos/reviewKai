
DELIMITER $$

CREATE PROCEDURE  `calculateNewPros` ( IN  NewUserID INT ) NOT DETERMINISTIC CONTAINS SQL SQL SECURITY DEFINER BEGIN

DECLARE userCount INT DEFAULT 0;
DECLARE userIndex INT DEFAULT 0;
DECLARE userToAdd INT DEFAULT 0;
Delete from  userToProreviewer where user_id=NewUserID;
DROP TEMPORARY TABLE IF EXISTS ub_rank;
create temporary table ub_rank as 
select similar.user_id,count(*) rank
FROM library target
JOIN ProReviewerLibrary similar ON target.game_id = similar.game_id
AND target.user_id != similar.user_id
AND target.rating
BETWEEN similar.rating -1
AND similar.rating +1
WHERE target.user_id = NewUserID
GROUP BY similar.user_id;

Select Count(*) into userCount from ub_rank;
if userCount > 10 then
	set userCount= 10;
end if;
set userIndex = 0; 
PREPARE stmt1 FROM 'select user_id into @userToAdd 
					from ub_rank order by rank desc
					limit ?, 1';
while userIndex < userCount Do

set @userIndex = userIndex;
EXECUTE stmt1 USING @userIndex;

Insert into userToProreviewer  (user_id, reviewer_id) values ( NewUserID,@userToAdd );
set userIndex=userIndex+1;

end while;
DEALLOCATE PREPARE stmt1;
END $$



DELIMITER $$

CREATE PROCEDURE  `calculateNewPeers` ( IN  NewUserID INT) NOT DETERMINISTIC CONTAINS SQL SQL SECURITY DEFINER BEGIN

DECLARE userCount INT DEFAULT 0;
DECLARE userIndex INT DEFAULT 0;
DECLARE userToAdd INT DEFAULT 0;
Delete from userToReviewers where user_id=NewUserID;
DROP TEMPORARY TABLE IF EXISTS ub_rank;
create temporary table ub_rank as 
select similar.user_id,count(*) rank
from library target  join library similar 
on target.game_id= similar.game_id 
and target.user_id != similar.user_id  
and target.rating between similar.rating-1 
and similar.rating+1 where target.user_id =NewUserID group by similar.user_id; 

Select Count(*) into userCount from ub_rank;
set userIndex = 0; 
if userCount > 20 then
	set userCount= 20;
end if;
PREPARE stmt1 FROM 'select user_id into @userToAdd 
					from ub_rank order by rank desc
					limit ?, 1';
while userIndex < userCount Do
set @userIndex = userIndex;
EXECUTE stmt1 USING @userIndex;

Insert into userToReviewers  (user_id, reviewer_id) values ( NewUserID,@userToAdd );
set userIndex=userIndex+1;

end while;
DEALLOCATE PREPARE stmt1;
END $$




DELIMITER $$

CREATE PROCEDURE  `fixextraGames` ( IN  startingpoint INT, IN  endingpoint INT   ) NOT DETERMINISTIC CONTAINS SQL SQL SECURITY DEFINER BEGIN
DECLARE gamestart INT DEFAULT 0;
set gamestart  = startingpoint+1;
update `ProReviewerLibrary` set game_id = startingpoint where game_id  between gamestart and endingpoint;

delete from  games where id  between gamestart and endingpoint;

END $$


DELIMITER $$
CREATE PROCEDURE  `updateFakeUsers` (  IN  startingpoint INT, IN  endingpoint INT  ) NOT DETERMINISTIC CONTAINS SQL SQL SECURITY DEFINER BEGIN

DECLARE currentGame INT DEFAULT 0;
DECLARE gameID INT DEFAULT 0;
DECLARE gameRating INT DEFAULT 0;
DECLARE newUserIndex INT DEFAULT 0;
set currentGame = startingpoint;

while currentGame < endingpoint+1 Do
set @currentGame= currentGame;

select u.fakeuserid, r.rating, r.game_id into @newUserIndex, @gameRating,@gameID  from ProReviewers u , ProReviewerLibrary r where r.user_id = u.id and r.id  = @currentGame; 

Insert into library  (user_id, game_id,rating) values ( @newUserIndex,@gameID ,@gameRating );
set currentGame = currentGame+1;
end while;



END $$

DELIMITER $$

CREATE PROCEDURE  `convertProLibraryToFakeUser` ( IN  userID INT , IN name nvarchar(256) ) NOT DETERMINISTIC CONTAINS SQL SQL SECURITY DEFINER BEGIN

DECLARE LibraryCount INT DEFAULT 0;
DECLARE gameIndex INT DEFAULT 0;
DECLARE newUser INT DEFAULT 0;
DECLARE gameID INT DEFAULT 0;
DECLARE gameRating INT DEFAULT 0;
DECLARE newUserIndex INT DEFAULT 0;
Insert into user (username, password, name) values ( name , 'd1um2m2my2pa2s2s2ord', name);
set newUserIndex = LAST_INSERT_ID();
Select count(*) into LibraryCount from ProReviewerLibrary where user_id = userID;

PREPARE stmt1 FROM 'select game_id, rating into @gameID, @gameRating
					from ProReviewerLibrary where user_id = ? 
					limit ?, 1';

while gameIndex < LibraryCount Do
set @gameIndex = gameIndex;
set @userid = userID;
set @newUserIndex = newUserIndex;
EXECUTE stmt1 USING @userid, @gameIndex;
Update ProReviewers set fakeuserid = @newUserIndex where id =  @userid;
Insert into library  (user_id, game_id,rating) values ( @newUserIndex,@gameID ,@gameRating );
set gameIndex=gameIndex+1;

end while;
DEALLOCATE PREPARE stmt1;
END $$
